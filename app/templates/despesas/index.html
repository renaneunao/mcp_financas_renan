{% extends "base.html" %}

{% block title %}Despesas{% endblock %}

{% block header %}
<div class="flex items-center justify-between">
    <div class="flex items-center">
        <div class="w-10 h-10 bg-gradient-to-r from-red-500 to-pink-600 rounded-lg flex items-center justify-center mr-3">
            <i class="fas fa-arrow-down text-white"></i>
        </div>
        <div>
            <h1 class="text-2xl font-bold text-white">Despesas</h1>
            <p class="text-gray-300 text-sm">Controle seus gastos e despesas</p>
        </div>
    </div>
    <a href="{{ url_for('despesas.nova') }}" 
       class="flex items-center px-6 py-3 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
        <i class="fas fa-plus mr-2"></i>Nova Despesa
    </a>
</div>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6">
    <!-- Filtros Compactos -->
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl shadow-2xl p-4">
        <form method="GET" id="filtroDespesasForm" class="flex items-center gap-3 flex-wrap">
            <!-- Filtro de Categoria -->
            <div class="flex items-center gap-2 min-w-0 flex-1">
                <i class="fas fa-folder text-red-400 text-xs"></i>
                <select name="categoria" id="categoriaSelect" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                    <option value="">Categoria</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {% if request.args.get('categoria') == categoria.id|string %}selected{% endif %}>
                            {{ categoria.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filtro de Subcategoria -->
            <div class="flex items-center gap-2 min-w-0 flex-1">
                <i class="fas fa-folder-open text-red-400 text-xs"></i>
                <select name="subcategoria" id="subcategoriaSelect" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200" disabled>
                    <option value="">Subcategoria</option>
                </select>
            </div>

            <!-- Filtro de Mês -->
            <div class="flex items-center gap-2 min-w-0 flex-1">
                <i class="fas fa-calendar-alt text-red-400 text-xs"></i>
                <select name="mes" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
                    <option value="">Mês</option>
                    <option value="1" {% if request.args.get('mes') == '1' %}selected{% endif %}>Jan</option>
                    <option value="2" {% if request.args.get('mes') == '2' %}selected{% endif %}>Fev</option>
                    <option value="3" {% if request.args.get('mes') == '3' %}selected{% endif %}>Mar</option>
                    <option value="4" {% if request.args.get('mes') == '4' %}selected{% endif %}>Abr</option>
                    <option value="5" {% if request.args.get('mes') == '5' %}selected{% endif %}>Mai</option>
                    <option value="6" {% if request.args.get('mes') == '6' %}selected{% endif %}>Jun</option>
                    <option value="7" {% if request.args.get('mes') == '7' %}selected{% endif %}>Jul</option>
                    <option value="8" {% if request.args.get('mes') == '8' %}selected{% endif %}>Ago</option>
                    <option value="9" {% if request.args.get('mes') == '9' %}selected{% endif %}>Set</option>
                    <option value="10" {% if request.args.get('mes') == '10' %}selected{% endif %}>Out</option>
                    <option value="11" {% if request.args.get('mes') == '11' %}selected{% endif %}>Nov</option>
                    <option value="12" {% if request.args.get('mes') == '12' %}selected{% endif %}>Dez</option>
                </select>
            </div>

            <!-- Filtro de Ano -->
            <div class="flex items-center gap-2 min-w-0">
                <i class="fas fa-calendar text-red-400 text-xs"></i>
                <input type="number" name="ano" value="{{ request.args.get('ano', '') }}" min="2000" max="2100" 
                       placeholder="Ano" class="w-20 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 text-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200">
            </div>

            <!-- Botão Limpar -->
            <a href="{{ url_for('despesas.index') }}" 
               class="bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white p-2 rounded-lg transition-all duration-200 flex items-center justify-center">
                <i class="fas fa-times text-xs"></i>
            </a>
        </form>
    </div>

    <!-- Estatísticas -->
    <div class="grid md:grid-cols-4 gap-6">
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-list text-red-400"></i>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Total de Despesas</p>
                    <p class="text-2xl font-bold text-white">{{ stats.total }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-money-bill-wave text-blue-400"></i>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Valor Total</p>
                    <p class="text-2xl font-bold text-white">R$ {{ "%.2f"|format(stats.valor_total)|replace('.', ',') }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-purple-500/20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-calculator text-purple-400"></i>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Média por Despesa</p>
                    <p class="text-2xl font-bold text-white">R$ {{ "%.2f"|format(stats.media_valor)|replace('.', ',') }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl p-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div>
                    <p class="text-gray-400 text-sm">Maior Despesa</p>
                    <p class="text-lg font-semibold text-white">R$ {{ "%.2f"|format(stats.maior_valor)|replace('.', ',') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Despesas -->
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl overflow-hidden">
        <div class="p-6 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-table text-red-400"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-white">Lista de Despesas</h3>
                        <p class="text-gray-400 text-sm">Ordenadas por data (mais recentes primeiro)</p>
                    </div>
                </div>
                <div class="text-red-400 text-sm font-medium">
                    {{ despesas|length }} despesa{{ 's' if despesas|length != 1 else '' }}
                </div>
            </div>
        </div>

        {% if despesas %}
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-800/50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                <i class="fas fa-folder mr-2"></i>Categoria
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                <i class="fas fa-calendar mr-2"></i>Data
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                <i class="fas fa-dollar-sign mr-2"></i>Valor
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                <i class="fas fa-repeat mr-2"></i>Recorrência
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                <i class="fas fa-check-circle mr-2"></i>Status
                            </th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                <i class="fas fa-cog mr-2"></i>Ações
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for despesa in despesas %}
                            <tr class="hover:bg-gray-800/30 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-folder text-red-400 text-sm"></i>
                                        </div>
                                        <div>
                                            <div class="text-white font-medium">{{ despesa.categoria_nome or 'Sem categoria' }}</div>
                                            {% if despesa.subcategoria_nome %}
                                                <div class="text-gray-400 text-sm">{{ despesa.subcategoria_nome }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-white">{{ despesa.data_inicio.strftime('%d/%m/%Y') if despesa.data_inicio else 'N/A' }}</div>
                                    {% if despesa.parcela_atual %}
                                        <div class="text-gray-400 text-sm">Parcela {{ despesa.parcela_atual }}/{{ despesa.numero_parcelas }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-red-400 font-semibold">R$ {{ "%.2f"|format(despesa.valor)|replace('.', ',') }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if despesa.tipo_recorrencia %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-red-500/20 text-red-300">
                                            <i class="fas fa-repeat mr-1"></i>
                                            {{ despesa.tipo_recorrencia|title }}
                                        </span>
                                        {% if despesa.dia_comum_pagamento %}
                                            <div class="text-gray-400 text-sm mt-1">Dia {{ despesa.dia_comum_pagamento }}</div>
                                        {% endif %}
                                    {% else %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-500/20 text-gray-300">
                                            <i class="fas fa-check mr-1"></i>
                                            Única
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <button onclick="togglePagamento('despesa', {{ despesa.id }}, {{ despesa.pago|tojson|safe }})" 
                                            class="text-xs px-2 py-1 rounded transition-colors duration-200 {{ 'bg-green-600 text-white flex items-center justify-center space-x-1' if despesa.pago else 'bg-gray-600 text-gray-300' }}"
                                            data-despesa-id="{{ despesa.id }}">
                                        {% if despesa.pago %}
                                            <img src="{{ url_for('static', filename='img/icones/pago.png') }}" 
                                                 alt="Pago" 
                                                 class="w-3 h-3">
                                            <span>Pago</span>
                                        {% else %}
                                            Pendente
                                        {% endif %}
                                    </button>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex space-x-2">
                                        <a href="{{ url_for('despesas.editar', id=despesa.id) }}" 
                                           class="flex items-center px-3 py-1 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg transition-colors text-xs">
                                            <i class="fas fa-edit mr-1"></i>Editar
                                        </a>
                                        <button onclick="confirmarExclusao({{ despesa.id }}, '{{ despesa.categoria_nome }}')" 
                                                class="flex items-center px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded-lg transition-colors text-xs">
                                            <i class="fas fa-trash mr-1"></i>Excluir
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="p-12 text-center">
                <div class="text-gray-500">
                    <i class="fas fa-receipt text-6xl mb-4 text-gray-600"></i>
                    <h3 class="text-xl font-semibold text-gray-400 mb-2">Nenhuma despesa encontrada</h3>
                    <p class="text-gray-500 mb-6">Comece adicionando sua primeira despesa para controlar seus gastos</p>
                    <a href="{{ url_for('despesas.nova') }}" 
                       class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Adicionar primeira despesa
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Auto-submit do formulário de filtros
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filtroDespesasForm');
    const selects = form.querySelectorAll('select');
    const inputs = form.querySelectorAll('input[type="number"]');
    
    [...selects, ...inputs].forEach(element => {
        element.addEventListener('change', function() {
            // Se for mudança de categoria, carregar subcategorias primeiro
            if (element.id === 'categoriaSelect') {
                const subcategoriaAtual = '{{ request.args.get("subcategoria", "") }}';
                carregarSubcategorias(element.value, subcategoriaAtual, true);
            } else {
                // Auto-submit para outros filtros
                form.submit();
            }
        });
    });
    
    // Carregar subcategorias se categoria já estiver selecionada
    const categoriaAtual = document.getElementById('categoriaSelect').value;
    const subcategoriaAtual = '{{ request.args.get("subcategoria", "") }}';
    if (categoriaAtual) {
        carregarSubcategorias(categoriaAtual, subcategoriaAtual, false);
    }
});

function carregarSubcategorias(categoriaId, subcategoriaSelecionada = '', autoSubmit = false) {
    const subcategoriaSelect = document.getElementById('subcategoriaSelect');
    
    if (!categoriaId) {
        subcategoriaSelect.innerHTML = '<option value="">Subcategoria</option>';
        subcategoriaSelect.disabled = true;
        if (autoSubmit) {
            document.getElementById('filtroDespesasForm').submit();
        }
        return;
    }
    
    // Mostrar loading
    subcategoriaSelect.innerHTML = '<option value="">Carregando...</option>';
    subcategoriaSelect.disabled = true;
    
    fetch(`/despesas/subcategorias/${categoriaId}`)
        .then(response => response.json())
        .then(subcategorias => {
            subcategoriaSelect.innerHTML = '<option value="">Subcategoria</option>';
            
            subcategorias.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.nome;
                if (subcategoriaSelecionada && sub.id == subcategoriaSelecionada) {
                    option.selected = true;
                }
                subcategoriaSelect.appendChild(option);
            });
            
            subcategoriaSelect.disabled = false;
            
            // Auto-submit após carregar subcategorias se solicitado
            if (autoSubmit) {
                document.getElementById('filtroDespesasForm').submit();
            }
        })
        .catch(error => {
            console.error('Erro ao carregar subcategorias:', error);
            subcategoriaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

function confirmarExclusao(despesaId, categoria) {
    if (confirm(`Tem certeza que deseja excluir a despesa "${categoria}"?\n\nEsta ação não pode ser desfeita.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/despesas/excluir/' + despesaId;
        document.body.appendChild(form);
        form.submit();
    }
}

// Animação de entrada das linhas da tabela
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        row.style.transition = 'all 0.5s ease';
        
        setTimeout(() => {
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 50);
    });
});
</script>
{% endblock %}
