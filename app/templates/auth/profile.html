{% extends "base.html" %}

{% block title %}Meu Perfil{% endblock %}

{% block header %}
<div class="flex items-center">
    <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
        <i class="fas fa-user-cog text-white"></i>
    </div>
    <div>
        <h1 class="text-2xl font-bold text-white">Meu Perfil</h1>
        <p class="text-gray-300 text-sm">Gerencie suas informações pessoais</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Card do Perfil Principal (2/3 da largura) -->
        <div class="lg:col-span-2">
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl overflow-hidden">
                <!-- Header do Card -->
                <div class="bg-gradient-to-r from-purple-600 to-blue-600 p-6">
                    <div class="flex items-center">
                        {% set foto_path = 'img/profile_users/' + session.username + '.jpg' %}
                        <div class="w-20 h-20 rounded-full overflow-hidden mr-6 backdrop-blur-sm border-2 border-white/30">
                            {% if url_for('static', filename=foto_path) %}
                                <img src="{{ url_for('static', filename=foto_path) }}" 
                                     alt="Foto de {{ session.username }}" 
                                     class="w-full h-full object-cover"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="w-full h-full bg-white/20 flex items-center justify-center" style="display: none;">
                                    <i class="fas fa-user text-white text-2xl"></i>
                                </div>
                            {% else %}
                                <div class="w-full h-full bg-white/20 flex items-center justify-center">
                                    <i class="fas fa-user text-white text-2xl"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="text-white">
                            <h2 class="text-2xl font-bold">{{ user.nome_completo or user.username }}</h2>
                            <p class="text-blue-100">@{{ user.username }}</p>
                            <p class="text-blue-200 text-sm mt-1">{{ user.email or 'Email não informado' }}</p>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo do Card -->
                <div class="p-8">
                    <form action="{{ url_for('auth.update_profile') }}" method="post" class="space-y-6">
                        <!-- Seção Foto de Perfil -->
                        <div class="space-y-6">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-camera text-purple-400"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-white">Foto de Perfil</h3>
                            </div>

                            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                                <div class="flex items-center space-x-6">
                                    <!-- Preview da foto atual -->
                                    <div class="relative">
                                        {% set foto_path = 'img/profile_users/' + session.username + '.jpg' %}
                                        <div id="profilePreview" class="w-24 h-24 rounded-full overflow-hidden border-2 border-purple-400">
                                            {% if url_for('static', filename=foto_path) %}
                                                <img id="currentProfileImg" src="{{ url_for('static', filename=foto_path) }}" 
                                                     alt="Foto de {{ session.username }}" 
                                                     class="w-full h-full object-cover"
                                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                <div id="defaultProfileIcon" class="w-full h-full bg-gradient-to-r from-purple-500 to-blue-600 flex items-center justify-center" style="display: none;">
                                                    <i class="fas fa-user text-white text-xl"></i>
                                                </div>
                                            {% else %}
                                                <img id="currentProfileImg" style="display: none;" class="w-full h-full object-cover">
                                                <div id="defaultProfileIcon" class="w-full h-full bg-gradient-to-r from-purple-500 to-blue-600 flex items-center justify-center">
                                                    <i class="fas fa-user text-white text-xl"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Botões de ação -->
                                    <div class="flex-1">
                                        <p class="text-gray-300 mb-4">Personalize seu perfil com uma foto</p>
                                        <div class="flex space-x-3">
                                            <button type="button" onclick="document.getElementById('profilePhotoUpload').click()" 
                                                    class="flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">
                                                <i class="fas fa-upload mr-2"></i>
                                                Adicionar Foto
                                            </button>
                                            <button type="button" onclick="removeProfilePhoto()" id="removePhotoBtn"
                                                    class="flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                                                <i class="fas fa-trash mr-2"></i>
                                                Remover Foto
                                            </button>
                                        </div>
                                        <input type="file" id="profilePhotoUpload" accept="image/*" style="display: none;" onchange="uploadProfilePhoto(this)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Divisor -->
                        <div class="border-t border-gray-700 my-8"></div>

                        <!-- Informações Pessoais -->
                        <div class="space-y-6">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-id-card text-blue-400"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-white">Informações Pessoais</h3>
                            </div>

                            <div class="grid md:grid-cols-2 gap-6">
                                <!-- Nome Completo -->
                                <div class="space-y-2">
                                    <label for="nome" class="block text-sm font-medium text-gray-300">
                                        <i class="fas fa-user mr-2 text-blue-400"></i>Nome Completo
                                    </label>
                                    <input type="text" 
                                           id="nome" 
                                           name="nome" 
                                           value="{{ user.nome_completo }}"
                                           required
                                           class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                </div>

                                <!-- Nome de Usuário (somente leitura) -->
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-300">
                                        <i class="fas fa-at mr-2 text-purple-400"></i>Nome de Usuário
                                    </label>
                                    <input type="text" 
                                           value="{{ user.username }}"
                                           disabled
                                           class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-gray-400 cursor-not-allowed">
                                    <p class="text-xs text-gray-500">O nome de usuário não pode ser alterado</p>
                                </div>
                            </div>
                        </div>

                        <!-- Divisor -->
                        <div class="border-t border-gray-700 my-8"></div>

                        <!-- Seção de Alteração de Senha -->
                        <div class="space-y-6">
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-lock text-red-400"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-white">Segurança</h3>
                                <span class="ml-auto text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded-full">Opcional</span>
                            </div>

                            <div class="grid md:grid-cols-3 gap-6">
                                <!-- Senha Atual -->
                                <div class="space-y-2">
                                    <label for="senha_atual" class="block text-sm font-medium text-gray-300">
                                        <i class="fas fa-key mr-2 text-yellow-400"></i>Senha Atual
                                    </label>
                                    <input type="password" 
                                           id="senha_atual" 
                                           name="senha_atual"
                                           placeholder="Digite sua senha atual"
                                           class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200">
                                </div>

                                <!-- Nova Senha -->
                                <div class="space-y-2">
                                    <label for="nova_senha" class="block text-sm font-medium text-gray-300">
                                        <i class="fas fa-shield-alt mr-2 text-green-400"></i>Nova Senha
                                    </label>
                                    <input type="password" 
                                           id="nova_senha" 
                                           name="nova_senha"
                                           placeholder="Mínimo 6 caracteres"
                                           class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200">
                                </div>

                                <!-- Confirmar Nova Senha -->
                                <div class="space-y-2">
                                    <label for="confirmar_senha" class="block text-sm font-medium text-gray-300">
                                        <i class="fas fa-check-double mr-2 text-blue-400"></i>Confirmar Senha
                                    </label>
                                    <input type="password" 
                                           id="confirmar_senha" 
                                           name="confirmar_senha"
                                           placeholder="Repita a nova senha"
                                           class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200">
                                </div>
                            </div>

                            <div class="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                                <div class="flex items-start">
                                    <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                                    <div class="text-sm text-blue-300">
                                        <p class="font-medium mb-1">Dicas de Segurança:</p>
                                        <ul class="list-disc list-inside space-y-1 text-blue-400">
                                            <li>Use uma senha com pelo menos 6 caracteres</li>
                                            <li>Combine letras maiúsculas, minúsculas e números</li>
                                            <li>Não use informações pessoais óbvias</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botões de Ação -->
                        <div class="flex justify-between items-center pt-6 border-t border-gray-700">
                            <a href="{{ url_for('dashboard.index') }}" 
                               class="flex items-center px-6 py-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-xl transition-all duration-200 group">
                                <i class="fas fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i>
                                Voltar
                            </a>
                            
                            <button type="submit" 
                                    class="flex items-center px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
                                <i class="fas fa-save mr-2"></i>
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Card de Informações da Conta (1/3 da largura) -->
        <div class="lg:col-span-1">
            <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-2xl p-6 h-fit">
                <div class="flex items-center mb-6">
                    <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-info-circle text-purple-400"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-white">Informações da Conta</h3>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-blue-500/20 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-calendar-alt text-blue-400"></i>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Membro desde</p>
                                <p class="text-white font-semibold">{{ user.data_criacao.strftime('%d/%m/%Y') if user.data_criacao else 'N/A' }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-check-circle text-green-400"></i>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Status</p>
                                <p class="text-green-400 font-semibold">{{ 'Ativo' if user.ativo else 'Inativo' }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800/50 rounded-xl p-4">
                        <div class="flex items-center">
                            <div class="w-12 h-12 bg-yellow-500/20 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-shield-alt text-yellow-400"></i>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Segurança</p>
                                <p class="text-yellow-400 font-semibold">Protegido</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Estatísticas Adicionais -->
                <div class="mt-6 pt-6 border-t border-gray-700">
                    <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <i class="fas fa-chart-bar text-purple-400 mr-2"></i>
                        Estatísticas
                    </h4>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Último acesso</span>
                            <span class="text-white text-sm font-medium">Hoje</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-400 text-sm">Perfil atualizado</span>
                            <span class="text-white text-sm font-medium">Agora</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Validação em tempo real das senhas
document.addEventListener('DOMContentLoaded', function() {
    const novaSenha = document.getElementById('nova_senha');
    const confirmarSenha = document.getElementById('confirmar_senha');
    const senhaAtual = document.getElementById('senha_atual');
    
    function validarSenhas() {
        if (novaSenha.value && confirmarSenha.value) {
            if (novaSenha.value === confirmarSenha.value) {
                confirmarSenha.classList.remove('border-red-500');
                confirmarSenha.classList.add('border-green-500');
            } else {
                confirmarSenha.classList.remove('border-green-500');
                confirmarSenha.classList.add('border-red-500');
            }
        }
    }
    
    novaSenha.addEventListener('input', validarSenhas);
    confirmarSenha.addEventListener('input', validarSenhas);
    
    // Se preencheu nova senha, senha atual é obrigatória
    novaSenha.addEventListener('input', function() {
        if (this.value) {
            senhaAtual.required = true;
            senhaAtual.classList.add('border-yellow-500');
        } else {
            senhaAtual.required = false;
            senhaAtual.classList.remove('border-yellow-500');
        }
    });
});

// Funções para gerenciamento de foto de perfil
function uploadProfilePhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validar tipo de arquivo
        if (!file.type.startsWith('image/')) {
            showToast('Por favor, selecione apenas arquivos de imagem.', 'error');
            return;
        }
        
        // Validar tamanho (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
            showToast('A imagem deve ter no máximo 5MB.', 'error');
            return;
        }
        
        // Mostrar preview
        const reader = new FileReader();
        reader.onload = function(e) {
            // Armazenar o arquivo para o crop
            currentFile = file;
            
            // Abrir modal de crop
            const cropModal = document.getElementById('cropModal');
            const cropImage = document.getElementById('cropImage');
            
            cropImage.src = e.target.result;
            cropModal.classList.remove('hidden');
            cropModal.classList.add('flex');
            
            // Inicializar cropper
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(cropImage, {
                aspectRatio: 1, // Quadrado
                viewMode: 2,
                autoCropArea: 0.8,
                responsive: true,
                restore: false,
                guides: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false,
            });
        };
        
        reader.readAsDataURL(file);
    }
}

function removeProfilePhoto() {
    if (confirm('Tem certeza que deseja remover sua foto de perfil?')) {
        fetch('/auth/remove-photo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualizar preview na página de perfil
                const currentImg = document.getElementById('currentProfileImg');
                const defaultIcon = document.getElementById('defaultProfileIcon');
                
                currentImg.style.display = 'none';
                defaultIcon.style.display = 'flex';
                
                // Atualizar também na sidebar se estiver visível
                const sidebarImg = document.querySelector('.w-12.h-12.rounded-full img');
                if (sidebarImg) {
                    sidebarImg.style.display = 'none';
                    const sidebarDefault = sidebarImg.nextElementSibling;
                    if (sidebarDefault) {
                        sidebarDefault.style.display = 'flex';
                    }
                }
                
                // Mostrar ícone de câmera na sidebar
                if (window.showCameraIcon) {
                    window.showCameraIcon();
                }
                
                showToast('Foto de perfil removida com sucesso!', 'success');
            } else {
                showToast(data.message || 'Erro ao remover foto de perfil', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro ao remover foto de perfil', 'error');
        });
    }
}

// Função para aplicar o crop na página de perfil
function applyCropFromProfile() {
    if (!cropper) return;
    
    const canvas = cropper.getCroppedCanvas({
        width: 300,
        height: 300,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });
    
    if (!canvas) {
        showToast('Erro ao processar a imagem. Tente novamente.', 'error');
        return;
    }
    
    canvas.toBlob(function(blob) {
        if (!blob) {
            showToast('Erro ao gerar a imagem. Tente novamente.', 'error');
            return;
        }
        
        // Mostrar loading no preview
        const preview = document.getElementById('profilePreview');
        const originalContent = preview.innerHTML;
        preview.innerHTML = '<div class="w-full h-full bg-gray-600 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-white"></i></div>';
        
        // Criar FormData com a imagem recortada
        const formData = new FormData();
        const fileName = currentFile ? currentFile.name : 'profile.jpg';
        formData.append('photo', blob, fileName);
        
        // Fazer upload
        fetch('/auth/upload-photo', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                closeCropModal();
                
                // Atualizar preview na página de perfil
                const timestamp = new Date().getTime();
                const newImageSrc = data.photo_url + '?t=' + timestamp;
                
                const currentImg = document.getElementById('currentProfileImg');
                const defaultIcon = document.getElementById('defaultProfileIcon');
                
                currentImg.src = newImageSrc;
                currentImg.style.display = 'block';
                defaultIcon.style.display = 'none';
                
                // Atualizar também na sidebar
                const sidebarImg = document.querySelector('.w-12.h-12.rounded-full img');
                if (sidebarImg) {
                    sidebarImg.src = newImageSrc;
                    sidebarImg.style.display = 'block';
                    const sidebarDefault = sidebarImg.nextElementSibling;
                    if (sidebarDefault) {
                        sidebarDefault.style.display = 'none';
                    }
                }
                
                // Esconder ícone de câmera na sidebar
                if (window.hideCameraIcon) {
                    window.hideCameraIcon();
                }
                
                showToast('Foto de perfil atualizada com sucesso!', 'success');
            } else {
                preview.innerHTML = originalContent;
                showToast(data.message || 'Erro ao atualizar foto de perfil', 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            preview.innerHTML = originalContent;
            showToast('Erro ao atualizar foto de perfil', 'error');
        });
    }, 'image/jpeg', 0.9);
}

// Sobrescrever a função applyCrop quando estiver na página de perfil
if (window.applyCrop) {
    window.applyCrop = applyCropFromProfile;
}

// Controlar visibilidade do botão remover foto
document.addEventListener('DOMContentLoaded', function() {
    const currentImg = document.getElementById('currentProfileImg');
    const removeBtn = document.getElementById('removePhotoBtn');
    
    if (currentImg && removeBtn) {
        // Se a imagem não está visível ou não existe, esconder o botão
        if (currentImg.style.display === 'none' || !currentImg.src || currentImg.src.includes('default')) {
            removeBtn.style.display = 'none';
        }
        
        // Observar mudanças na imagem para mostrar/esconder o botão
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (currentImg.style.display === 'none') {
                        removeBtn.style.display = 'none';
                    } else {
                        removeBtn.style.display = 'flex';
                    }
                }
            });
        });
        
        observer.observe(currentImg, { attributes: true });
    }
});

// Função de toast simples para a página de perfil
function showToast(message, type = 'info') {
    // Criar elemento de toast
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300 ${
        type === 'success' ? 'bg-green-600 text-white' : 
        type === 'error' ? 'bg-red-600 text-white' : 
        'bg-blue-600 text-white'
    }`;
    
    toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle'} mr-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animar entrada
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remover após 3 segundos
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
</script>
{% endblock %}
